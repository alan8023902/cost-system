# Test Plan｜工程成本计划与税务计控系统（一期全量）

## 1. 测试范围
- 登录与安全（验证码、锁定、token续期、禁用失效）
- 项目隔离与权限（最关键）
- 版本状态机（Draft/InApproval/Approved/Issued）
- 明细可扩展（类别新增、行增删、批量粘贴/导入）
- 规则计算与追溯（口径正确、trace完整）
- 审批流闭环（退回、再提交、通过）
- 签发冻结与盖章（不可变、防篡改）
- 导入导出（版式、权限、下载）
- 审计日志（字段级diff、关键动作全覆盖）
- 性能与并发（大行数、草稿锁）

## 2. 权限矩阵（角色×动作×版本状态）
### 2.1 动作与状态

| 动作\状态 | Draft | InApproval | Approved | Issued | Archived |
|-----------|-------|------------|----------|--------|----------|
| ITEM_WRITE/DELETE/IMPORT | ✅ | ❌ | ❌ | ❌ | ❌ |
| ITEM_READ | ✅ | ✅ | ✅ | ✅ | ✅ |
| VERSION_SUBMIT | ✅ | ❌ | ❌ | ❌ | ❌ |
| TASK_APPROVE/REJECT | ❌ | ✅ | ❌ | ❌ | ❌ |
| VERSION_ISSUE | ❌ | ❌ | ✅ | ❌ | ❌ |
| ITEM_EXPORT / FILE_DOWNLOAD | ✅ | ✅ | ✅ | ✅ | ✅ |
| SEAL_EXECUTE | ❌ | ❌ | ❌ | ✅ | ❌ |

### 2.2 项目角色与动作

| 项目角色 | 读明细 | 写明细(Draft) | 提交 | 审批 | 签发 | 盖章 | 成员管理 |
|----------|--------|---------------|------|------|------|------|----------|
| PROJECT_ADMIN | ✅ | ✅ | ✅ | 可选 | ✅ | ✅ | ✅ |
| EDITOR | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ |
| REVIEWER | ✅ | ✅ | ✅ | ❌/可选 | ❌ | ❌ | ❌ |
| APPROVER | ✅ | ❌ | ❌ | ✅ | ❌ | ❌ | ❌ |
| SEAL_ADMIN | ✅ | ❌ | ❌ | ❌ | ✅ | ✅ | ❌ |
| VIEWER | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |

## 3. 核心用例（必须全过）
### 3.1 登录与安全
- L1：正确账号密码登录成功，返回access/refresh
- L2：错误密码连续5次锁定15分钟
- L3：DISABLED用户登录失败
- L4：修改密码后旧token立即失效（token_version验证）
- L5：refresh token过期后必须重新登录

### 3.2 项目隔离与下载鉴权
- P1：非项目成员访问 `/versions/{id}` 返回403
- P2：非项目成员调用 `/export/pdf` 返回403
- P3：非项目成员下载 `/files/{fileId}` 返回403
- P4：成员被移除后立即失去访问权限

### 3.3 版本状态机硬校验
- S1：Draft可新增/编辑/删除明细
- S2：InApproval任何写接口返回409/403（含batch、import）
- S3：Approved不可写，只允许签发
- S4：Issued不可写，只允许导出与盖章
- S5：Archived全只读

### 3.4 明细扩展（防返工点）
- E1：新增材料类别（字典配置）后可选、可新增行
- E2：新增费用类别后可正常录入并参与指标计算
- E3：同版本新增1000行明细批量保存成功
- E4：删除中间行后排序正常，重算指标正确

### 3.5 规则计算与追溯
- C1：固定输入数据，指标输出与预期一致（0误差）
- C2：点击指标查看trace：规则id、表达式、命中行id齐全
- C3：修改一行金额后，相关指标变化正确且trace更新
- C4：指标依赖链按order执行且无循环依赖报错

### 3.6 审批闭环
- W1：提交后进入InApproval并生成待办
- W2：审批退回→回到Draft→可编辑→再次提交
- W3：审批通过进入Approved
- W4：签发进入Issued并冻结

### 3.7 导入导出与盖章
- IO1：导入Excel预览成功，确认导入后生成明细行
- IO2：导出Excel字段顺序与版式符合模板
- IO3：导出PDF版式正确
- SE1：Issued版本可盖章，生成sealed PDF并记录hash
- SE2：非Issued调用盖章接口必须拒绝
- SE3：sealed PDF下载鉴权正确

### 3.8 审计日志
- A1：明细金额字段变更记录old/new、操作者、时间、version
- A2：提交/审批/签发/导出/下载/盖章全部有审计记录
- A3：审计记录可按project/version查询

## 4. 性能与并发
- PERF1：1000行明细重算在可接受时间内完成（设定阈值）
- PERF2：同版本并发编辑：草稿锁生效，提示“被占用”
- PERF3：导出PDF/Excel并发请求不影响数据一致性
