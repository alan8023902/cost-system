# æ•°æ®åº“éƒ¨ç½²æ–¹æ¡ˆ

## ğŸ“‹ è®¾è®¡ç†å¿µ

### å¼€å‘ç¯å¢ƒ
- **è‡ªåŠ¨ç®¡ç†è¡¨ç»“æ„** - ä½¿ç”¨ `ddl-auto: update`
- **ä¿ç•™å¼€å‘æ•°æ®** - ä¸ä¼šåˆ é™¤æ•°æ®
- **å¿«é€Ÿè¿­ä»£** - ä¿®æ”¹å®ä½“ç±»è‡ªåŠ¨åŒæ­¥

### ç”Ÿäº§ç¯å¢ƒ
- **æ‰‹åŠ¨éƒ¨ç½²SQL** - å®Œå…¨å¯æ§
- **ä¸€æ¬¡æ€§å»ºè¡¨** - ä¸Šçº¿å‰æ‰§è¡Œå®Œæ•´SQL
- **åªéªŒè¯ä¸ä¿®æ”¹** - `ddl-auto: validate`

---

## ğŸš€ éƒ¨ç½²æµç¨‹

### 1. å¼€å‘é˜¶æ®µï¼ˆç°åœ¨ï¼‰

```yaml
# application-dev.yml
spring.jpa.hibernate.ddl-auto: update
spring.flyway.enabled: false
```

**å·¥ä½œæ–¹å¼**ï¼š
- ç¬¬ä¸€æ¬¡å¯åŠ¨ï¼šè‡ªåŠ¨åˆ›å»ºæ‰€æœ‰è¡¨
- åç»­å¯åŠ¨ï¼šè‡ªåŠ¨æ›´æ–°è¡¨ç»“æ„ï¼ˆæ·»åŠ å­—æ®µ/ç´¢å¼•ï¼‰
- **æ•°æ®ä¸ä¼šä¸¢å¤±** - `update`æ¨¡å¼åªå¢ä¸å‡

**åˆå§‹åŒ–æ•°æ®**ï¼š
```bash
# é¦–æ¬¡å¯åŠ¨æˆ–éœ€è¦æµ‹è¯•æ•°æ®æ—¶
é‡ç½®æ•°æ®åº“.bat
restart-backend.bat
```

---

### 2. ä¸Šçº¿éƒ¨ç½²ï¼ˆä¸€æ¬¡æ€§ï¼‰

#### æ­¥éª¤1ï¼šå¯¼å‡ºå®Œæ•´å»ºè¡¨SQL
```bash
# å¯åŠ¨å¼€å‘ç¯å¢ƒï¼Œè®©JPAç”Ÿæˆæ‰€æœ‰è¡¨
cd cost-backend
mvn spring-boot:run -Dspring.profiles.active=dev

# ç„¶åå¯¼å‡ºè¡¨ç»“æ„
mysqldump -u root -pliurongai --no-data cost_system_dev > deploy/init-database-prod.sql
```

#### æ­¥éª¤2ï¼šå‡†å¤‡ç”Ÿäº§åˆå§‹æ•°æ®
```sql
-- deploy/init-data-prod.sql
-- ç®¡ç†å‘˜è´¦å·ï¼ˆå®¢æˆ·è‡ªå·±è®¾ç½®å¯†ç ï¼‰
INSERT INTO cost_user (username, password_hash, phone, email, status, created_at, updated_at)
VALUES ('admin', '$2a$10$...', 'å®¢æˆ·æ‰‹æœºå·', 'å®¢æˆ·é‚®ç®±', 'ACTIVE', NOW(), NOW());

-- å…¶ä»–åˆå§‹é…ç½®...
```

#### æ­¥éª¤3ï¼šç”Ÿäº§ç¯å¢ƒæ‰§è¡Œ
```bash
# 1. åˆ›å»ºç”Ÿäº§æ•°æ®åº“
mysql -u root -p -e "CREATE DATABASE cost_system CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# 2. å¯¼å…¥è¡¨ç»“æ„
mysql -u root -p cost_system < deploy/init-database-prod.sql

# 3. å¯¼å…¥åˆå§‹æ•°æ®
mysql -u root -p cost_system < deploy/init-data-prod.sql
```

#### æ­¥éª¤4ï¼šç”Ÿäº§é…ç½®
```yaml
# application-prod.yml
spring.jpa.hibernate.ddl-auto: validate  # åªéªŒè¯ï¼Œä¸ä¿®æ”¹è¡¨
spring.flyway.enabled: false
```

---

### 3. åç»­è¡¨ç»“æ„å˜æ›´ï¼ˆå¦‚æœéœ€è¦ï¼‰

#### å¼€å‘ç¯å¢ƒæµ‹è¯•
```bash
# 1. ä¿®æ”¹Entityç±»
# 2. é‡å¯åç«¯ - JPAè‡ªåŠ¨æ›´æ–°è¡¨

# 3. å¯¼å‡ºå˜æ›´SQL
mysqldump -u root -p --no-data cost_system_dev > latest-schema.sql

# 4. å¯¹æ¯”å·®å¼‚ï¼Œç”Ÿæˆå¢é‡SQL
```

#### ç”Ÿäº§ç¯å¢ƒæ›´æ–°
```sql
-- deploy/upgrade-v1.1.sql
-- æ‰‹åŠ¨ç¼–å†™å¢é‡SQL
ALTER TABLE cost_user ADD COLUMN new_field VARCHAR(100);
CREATE INDEX idx_new_field ON cost_user(new_field);
```

```bash
# æ‰§è¡Œå‡çº§
mysql -u root -p cost_system < deploy/upgrade-v1.1.sql
```

---

## ğŸ¯ å„ç¯å¢ƒé…ç½®å¯¹æ¯”

| ç¯å¢ƒ | ddl-auto | Flyway | è¯´æ˜ |
|------|----------|--------|------|
| å¼€å‘ | `update` | âŒ ç¦ç”¨ | è‡ªåŠ¨åŒæ­¥è¡¨ç»“æ„ï¼Œä¿ç•™æ•°æ® |
| æµ‹è¯• | `update` | âŒ ç¦ç”¨ | åŒå¼€å‘ç¯å¢ƒ |
| ç”Ÿäº§ | `validate` | âŒ ç¦ç”¨ | åªéªŒè¯ï¼Œå¿…é¡»æ‰‹åŠ¨SQLéƒ¨ç½² |

---

## ğŸ“ éƒ¨ç½²æ–‡ä»¶ç»“æ„

```
deploy/
â”œâ”€â”€ init-database-prod.sql      # å®Œæ•´å»ºè¡¨SQLï¼ˆä¸Šçº¿å‰ç”Ÿæˆï¼‰
â”œâ”€â”€ init-data-prod.sql          # åˆå§‹æ•°æ®SQLï¼ˆå®¢æˆ·å®šåˆ¶ï¼‰
â”œâ”€â”€ upgrade-v1.1.sql            # ç‰ˆæœ¬å‡çº§SQLï¼ˆå¦‚æœéœ€è¦ï¼‰
â”œâ”€â”€ upgrade-v1.2.sql
â””â”€â”€ æ•°æ®åº“éƒ¨ç½²è¯´æ˜.md
```

---

## âœ… ä¼˜åŠ¿

### å¼€å‘é˜¶æ®µ
âœ… ä¸éœ€è¦å†™å»ºè¡¨SQL  
âœ… ä¸éœ€è¦å†™è¿ç§»è„šæœ¬  
âœ… ä¿®æ”¹Entityè‡ªåŠ¨åŒæ­¥  
âœ… æ•°æ®ä¸ä¼šä¸¢å¤±ï¼ˆupdateæ¨¡å¼ï¼‰  
âœ… å¿«é€Ÿè¿­ä»£å¼€å‘  

### ç”Ÿäº§éƒ¨ç½²
âœ… ä¸€æ¬¡æ€§å®Œæ•´å»ºè¡¨  
âœ… å®Œå…¨å¯æ§çš„SQL  
âœ… ä¸ä¾èµ–Flyway  
âœ… å®¢æˆ·æ•°æ®ç»å¯¹å®‰å…¨  
âœ… å¯ä»¥äººå·¥å®¡æ ¸æ¯ä¸ªSQL  

---

## ğŸ›¡ï¸ å®‰å…¨ä¿éšœ

### å¼€å‘ç¯å¢ƒ
- `update`æ¨¡å¼ï¼šåªä¼š**æ·»åŠ **è¡¨/å­—æ®µï¼Œä¸ä¼šåˆ é™¤
- å¦‚æœéœ€è¦åˆ é™¤å­—æ®µï¼Œéœ€è¦æ‰‹åŠ¨æ‰§è¡ŒSQL

### ç”Ÿäº§ç¯å¢ƒ
- `validate`æ¨¡å¼ï¼šå¯åŠ¨æ—¶éªŒè¯è¡¨ç»“æ„æ˜¯å¦åŒ¹é…Entity
- å¦‚æœä¸åŒ¹é…ä¼šå¯åŠ¨å¤±è´¥ï¼Œä¸ä¼šè‡ªåŠ¨ä¿®æ”¹
- æ‰€æœ‰å˜æ›´å¿…é¡»äººå·¥å®¡æ ¸

---

## ğŸ“ æœ€ä½³å®è·µ

1. **å¼€å‘é˜¶æ®µ**ï¼šéšä¾¿æ”¹Entityï¼ŒJPAè‡ªåŠ¨åŒæ­¥
2. **åŠŸèƒ½ç¨³å®šå**ï¼šå¯¼å‡ºå®Œæ•´SQLï¼Œå‡†å¤‡ä¸Šçº¿
3. **ä¸Šçº¿éƒ¨ç½²**ï¼šä¸€æ¬¡æ€§æ‰§è¡Œå®Œæ•´SQL
4. **åç»­å‡çº§**ï¼šæ‰‹åŠ¨ç¼–å†™å¢é‡SQLï¼Œäººå·¥å®¡æ ¸åæ‰§è¡Œ

**ä¸éœ€è¦Flywayï¼Œç®€å•å¯æ§ï¼** ğŸ‰
