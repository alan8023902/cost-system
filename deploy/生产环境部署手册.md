# å»ºææˆæœ¬ç®¡ç†ç³»ç»Ÿ - ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ‰‹å†Œ

## ğŸ“‹ ç›®å½•
- [ç³»ç»Ÿè¦æ±‚](#ç³»ç»Ÿè¦æ±‚)
- [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
- [éƒ¨ç½²æ–¹å¼é€‰æ‹©](#éƒ¨ç½²æ–¹å¼é€‰æ‹©)
- [æ–¹å¼ä¸€ï¼šDocker éƒ¨ç½²ï¼ˆæ¨èï¼‰](#æ–¹å¼ä¸€docker-éƒ¨ç½²æ¨è)
- [æ–¹å¼äºŒï¼šä¼ ç»Ÿéƒ¨ç½²](#æ–¹å¼äºŒä¼ ç»Ÿéƒ¨ç½²)
- [ç¯å¢ƒå˜é‡é…ç½®](#ç¯å¢ƒå˜é‡é…ç½®)
- [å¯åŠ¨ä¸åœæ­¢](#å¯åŠ¨ä¸åœæ­¢)
- [ç›‘æ§ä¸æ—¥å¿—](#ç›‘æ§ä¸æ—¥å¿—)
- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## ç³»ç»Ÿè¦æ±‚

### æœåŠ¡å™¨é…ç½®å»ºè®®
- **CPU**: 4æ ¸åŠä»¥ä¸Š
- **å†…å­˜**: 8GBåŠä»¥ä¸Š
- **ç¡¬ç›˜**: 100GBåŠä»¥ä¸Š(SSDæ¨è)
- **æ“ä½œç³»ç»Ÿ**: Linux(æ¨èCentOS 7+/Ubuntu 20.04+) æˆ– Windows Server 2019+

### è½¯ä»¶ä¾èµ–

#### Docker éƒ¨ç½²
| è½¯ä»¶ | ç‰ˆæœ¬è¦æ±‚ | è¯´æ˜ |
|------|---------|------|
| Docker | 20.10+ | å®¹å™¨è¿è¡Œç¯å¢ƒ |
| Docker Compose | 2.0+ | å®¹å™¨ç¼–æ’å·¥å…· |

#### ä¼ ç»Ÿéƒ¨ç½²
| è½¯ä»¶ | ç‰ˆæœ¬è¦æ±‚ | è¯´æ˜ |
|------|---------|------|
| JDK | 17+ | åç«¯è¿è¡Œç¯å¢ƒ |
| Node.js | 18+ | å‰ç«¯æ„å»ºå·¥å…· |
| MySQL | 8.0+ | ç”Ÿäº§æ•°æ®åº“ |
| Redis | 7.0+ | ç¼“å­˜æœåŠ¡ |
| Nginx | 1.18+ | åå‘ä»£ç†ä¸é™æ€èµ„æºæœåŠ¡ |

---

## éƒ¨ç½²æ¶æ„

```
[å®¢æˆ·ç«¯æµè§ˆå™¨]
      â†“
[Nginx :38443]
      â†“
   â”Œâ”€â”€â”´â”€â”€â”
   â†“     â†“
[å‰ç«¯é™æ€èµ„æº]  [åç«¯API :31943]
                    â†“
                 â”Œâ”€â”€â”´â”€â”€â”
                 â†“     â†“
            [MySQL]  [Redis]
```

### ç«¯å£åˆ†é…
- **å‰ç«¯ Nginx**: 38443
- **åç«¯ API**: 31943
- **MySQL**: 3306
- **Redis**: 6379

---

## éƒ¨ç½²æ–¹å¼é€‰æ‹©

### Docker éƒ¨ç½²ï¼ˆæ¨èï¼‰
**ä¼˜ç‚¹**:
- âœ… ä¸€é”®éƒ¨ç½²ï¼Œç¯å¢ƒéš”ç¦»
- âœ… æ˜“äºè¿ç§»å’Œæ‰©å±•
- âœ… ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æœåŠ¡
- âœ… è‡ªåŠ¨å¥åº·æ£€æŸ¥å’Œé‡å¯

**é€‚ç”¨åœºæ™¯**: æ–°é¡¹ç›®ã€äº‘æœåŠ¡å™¨ã€å®¹å™¨åŒ–ç¯å¢ƒ

### ä¼ ç»Ÿéƒ¨ç½²
**ä¼˜ç‚¹**:
- âœ… æ›´çµæ´»çš„é…ç½®
- âœ… æ›´å¥½çš„æ€§èƒ½è°ƒä¼˜
- âœ… é€‚åˆå·²æœ‰åŸºç¡€è®¾æ–½

**é€‚ç”¨åœºæ™¯**: å·²æœ‰æ•°æ®åº“ã€éœ€è¦ç²¾ç»†æ§åˆ¶ã€ä¼ ç»Ÿè¿ç»´ç¯å¢ƒ

---

## æ–¹å¼ä¸€ï¼šDocker éƒ¨ç½²ï¼ˆæ¨èï¼‰

### 1. å‰ææ¡ä»¶

#### å®‰è£… Docker
```bash
# CentOS/RHEL
sudo yum install -y docker-ce docker-ce-cli containerd.io
sudo systemctl start docker
sudo systemctl enable docker

# Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y docker.io docker-compose
sudo systemctl start docker
sudo systemctl enable docker

# éªŒè¯å®‰è£…
docker --version
docker-compose --version
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

åˆ›å»º `.env` æ–‡ä»¶ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰:

```bash
# .env
# ==================== æ•°æ®åº“é…ç½® ====================
MYSQL_ROOT_PASSWORD=your_strong_mysql_password_here
MYSQL_DATABASE=cost_system

# ==================== Redis é…ç½® ====================
REDIS_PASSWORD=your_strong_redis_password_here

# ==================== åç«¯é…ç½® ====================
SPRING_PROFILES_ACTIVE=prod
SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/cost_system?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
SPRING_DATASOURCE_USERNAME=root
SPRING_DATASOURCE_PASSWORD=your_strong_mysql_password_here
SPRING_REDIS_HOST=redis
SPRING_REDIS_PORT=6379
SPRING_REDIS_PASSWORD=your_strong_redis_password_here

# ==================== JWT é…ç½® ====================
JWT_SECRET=your_jwt_secret_key_at_least_32_characters_long_random_string
JWT_EXPIRATION=86400000
JWT_REFRESH_EXPIRATION=604800000

# ==================== æ–‡ä»¶ä¸Šä¼ é…ç½® ====================
FILE_UPLOAD_PATH=/app/uploads
FILE_MAX_SIZE=100MB

# ==================== æ—¥å¿—é…ç½® ====================
LOG_FILE_PATH=/app/logs/cost-system.log

# ==================== ç«¯å£é…ç½® ====================
BACKEND_PORT=31943
FRONTEND_PORT=38443
MYSQL_PORT=3306
REDIS_PORT=6379
```

**å®‰å…¨æç¤º**:
- ğŸ”’ ç”Ÿæˆå¼ºå¯†ç : `openssl rand -base64 32`
- ğŸ”’ ç”Ÿæˆ JWT Secret: `openssl rand -base64 64`
- ğŸ”’ ä¸è¦å°† `.env` æ–‡ä»¶æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶

### 3. æ›´æ–° docker-compose.yml

ç¼–è¾‘ `docker-compose.yml` ä½¿ç”¨ç¯å¢ƒå˜é‡:

```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: cost-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
      TZ: Asia/Shanghai
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./deploy/mysql-init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    command: --default-authentication-plugin=mysql_native_password
    networks:
      - cost-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: cost-redis
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    networks:
      - cost-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ./cost-backend
      dockerfile: Dockerfile
    container_name: cost-backend
    restart: always
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL}
      SPRING_DATASOURCE_USERNAME: ${SPRING_DATASOURCE_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD}
      SPRING_REDIS_HOST: ${SPRING_REDIS_HOST}
      SPRING_REDIS_PORT: ${SPRING_REDIS_PORT}
      SPRING_REDIS_PASSWORD: ${SPRING_REDIS_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION}
      JWT_REFRESH_EXPIRATION: ${JWT_REFRESH_EXPIRATION}
      FILE_UPLOAD_PATH: ${FILE_UPLOAD_PATH}
      FILE_MAX_SIZE: ${FILE_MAX_SIZE}
      LOG_FILE_PATH: ${LOG_FILE_PATH}
      TZ: Asia/Shanghai
    ports:
      - "${BACKEND_PORT:-31943}:31943"
    volumes:
      - backend-uploads:/app/uploads
      - backend-logs:/app/logs
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - cost-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:31943/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  frontend:
    build:
      context: ./cost-frontend-react
      dockerfile: Dockerfile
    container_name: cost-frontend
    restart: always
    ports:
      - "${FRONTEND_PORT:-38443}:38443"
    depends_on:
      - backend
    networks:
      - cost-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:38443"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  cost-network:
    driver: bridge

volumes:
  mysql-data:
    driver: local
  redis-data:
    driver: local
  backend-uploads:
    driver: local
  backend-logs:
    driver: local
```

### 4. éƒ¨ç½²æ­¥éª¤

#### ä½¿ç”¨éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰

**Linux/macOS**:
```bash
chmod +x deploy-docker.sh
./deploy-docker.sh
```

**Windows**:
```bash
deploy-docker.bat
```

#### æ‰‹åŠ¨éƒ¨ç½²

```bash
# 1. æ„å»ºé•œåƒ
docker-compose build --no-cache

# 2. å¯åŠ¨æœåŠ¡
docker-compose up -d

# 3. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# 4. æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose ps
```

### 5. éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥æ‰€æœ‰å®¹å™¨çŠ¶æ€
docker-compose ps

# æ£€æŸ¥åç«¯å¥åº·
curl http://localhost:31943/actuator/health

# æ£€æŸ¥å‰ç«¯
curl http://localhost:38443

# è®¿é—®ç³»ç»Ÿ
# æµè§ˆå™¨æ‰“å¼€: http://your-server-ip:38443
```

### 6. Docker å¸¸ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f backend
docker-compose logs -f frontend
docker-compose logs --tail=100 mysql

# é‡å¯æœåŠ¡
docker-compose restart backend
docker-compose restart

# åœæ­¢æœåŠ¡
docker-compose stop

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨ï¼ˆä¿ç•™æ•°æ®ï¼‰
docker-compose down

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨å’Œæ•°æ®
docker-compose down -v

# è¿›å…¥å®¹å™¨
docker exec -it cost-backend bash
docker exec -it cost-mysql mysql -uroot -p${MYSQL_ROOT_PASSWORD}
docker exec -it cost-redis redis-cli -a ${REDIS_PASSWORD}

# æ›´æ–°æœåŠ¡
git pull
docker-compose build --no-cache
docker-compose up -d
```

---

## æ–¹å¼äºŒï¼šä¼ ç»Ÿéƒ¨ç½²


---

## æ–¹å¼äºŒï¼šä¼ ç»Ÿéƒ¨ç½²

### 1. å‡†å¤‡æ•°æ®åº“

#### 1.1 å®‰è£… MySQL å’Œ Redis

**CentOS/RHEL**:
```bash
# å®‰è£… MySQL
sudo yum install -y mysql-server
sudo systemctl start mysqld
sudo systemctl enable mysqld

# å®‰è£… Redis
sudo yum install -y redis
sudo systemctl start redis
sudo systemctl enable redis
```

**Ubuntu/Debian**:
```bash
# å®‰è£… MySQL
sudo apt-get update
sudo apt-get install -y mysql-server
sudo systemctl start mysql
sudo systemctl enable mysql

# å®‰è£… Redis
sudo apt-get install -y redis-server
sudo systemctl start redis
sudo systemctl enable redis
```

#### 1.2 åˆ›å»ºæ•°æ®åº“
```bash
# ç™»å½•MySQL
mysql -u root -p

# åˆ›å»ºæ•°æ®åº“
CREATE DATABASE cost_system DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# åˆ›å»ºä¸“ç”¨ç”¨æˆ·(æ¨è)
CREATE USER 'cost_admin'@'%' IDENTIFIED BY 'your_strong_password';
GRANT ALL PRIVILEGES ON cost_system.* TO 'cost_admin'@'%';
FLUSH PRIVILEGES;
```

#### 1.3 æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
```bash
# åˆ‡æ¢åˆ°éƒ¨ç½²ç›®å½•
cd /path/to/cost-system/deploy

# æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
mysql -u cost_admin -p cost_system < mysql-init.sql
```

#### 1.4 é…ç½® Redis
```bash
# ç¼–è¾‘ Redis é…ç½®
sudo vi /etc/redis/redis.conf

# è®¾ç½®å¯†ç 
requirepass your_strong_redis_password

# é‡å¯ Redis
sudo systemctl restart redis
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶ `/etc/profile.d/cost-system.sh`:

```bash
#!/bin/bash
# å»ºææˆæœ¬ç®¡ç†ç³»ç»Ÿç¯å¢ƒå˜é‡

# ==================== æ•°æ®åº“é…ç½® ====================
export SPRING_DATASOURCE_URL="jdbc:mysql://localhost:3306/cost_system?useUnicode=true&characterEncoding=utf8&useSSL=true&serverTimezone=Asia/Shanghai"
export SPRING_DATASOURCE_USERNAME="cost_admin"
export SPRING_DATASOURCE_PASSWORD="your_strong_password"

# ==================== Redis é…ç½® ====================
export SPRING_REDIS_HOST="localhost"
export SPRING_REDIS_PORT="6379"
export SPRING_REDIS_PASSWORD="your_strong_redis_password"

# ==================== JWT é…ç½® ====================
export JWT_SECRET="your_jwt_secret_key_at_least_32_characters_long"
export JWT_EXPIRATION="86400000"
export JWT_REFRESH_EXPIRATION="604800000"

# ==================== æ–‡ä»¶ä¸Šä¼ é…ç½® ====================
export FILE_UPLOAD_PATH="/var/cost-system/uploads"
export FILE_MAX_SIZE="100MB"

# ==================== æ—¥å¿—é…ç½® ====================
export LOG_FILE_PATH="/var/log/cost-system/application.log"

# ==================== Spring Security é…ç½® ====================
export SPRING_SECURITY_USER="admin"
export SPRING_SECURITY_PASSWORD="your_admin_password"
```

åŠ è½½ç¯å¢ƒå˜é‡:
```bash
# ä½¿ç¯å¢ƒå˜é‡ç”Ÿæ•ˆ
source /etc/profile.d/cost-system.sh

# éªŒè¯
echo $SPRING_DATASOURCE_URL
```

### 3. éƒ¨ç½²åç«¯æœåŠ¡

#### 3.1 æ‰“åŒ…åç«¯åº”ç”¨
```bash
# è¿›å…¥åç«¯ç›®å½•
cd cost-backend

# ä½¿ç”¨Mavenæ‰“åŒ…ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
mvn clean package -DskipTests -Pprod

# ç”Ÿæˆçš„JARåŒ…ä½ç½®
ls -lh target/cost-backend-*.jar
```

#### 3.2 åˆ›å»ºéƒ¨ç½²ç›®å½•
```bash
# åˆ›å»ºç›®å½•
sudo mkdir -p /opt/cost-system
sudo mkdir -p /var/cost-system/uploads
sudo mkdir -p /var/log/cost-system

# å¤åˆ¶JARåŒ…
sudo cp target/cost-backend-*.jar /opt/cost-system/cost-backend.jar

# è®¾ç½®æƒé™
sudo useradd -r -s /bin/false cost
sudo chown -R cost:cost /opt/cost-system
sudo chown -R cost:cost /var/cost-system
sudo chown -R cost:cost /var/log/cost-system
```

#### 3.3 åˆ›å»º systemd æœåŠ¡

åˆ›å»ºæœåŠ¡æ–‡ä»¶ `/etc/systemd/system/cost-backend.service`:

```ini
[Unit]
Description=Cost Management System Backend
After=syslog.target network.target mysql.service redis.service
Wants=mysql.service redis.service

[Service]
Type=simple
User=cost
Group=cost
WorkingDirectory=/opt/cost-system

# ç¯å¢ƒå˜é‡æ–‡ä»¶
EnvironmentFile=/etc/profile.d/cost-system.sh

# JVM å‚æ•°
Environment="JAVA_OPTS=-Xms2g -Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/var/log/cost-system/heap_dump.hprof"

# å¯åŠ¨å‘½ä»¤
ExecStart=/usr/bin/java $JAVA_OPTS -jar /opt/cost-system/cost-backend.jar --spring.profiles.active=prod

# é‡å¯ç­–ç•¥
SuccessExitStatus=143
Restart=on-failure
RestartSec=10
StandardOutput=journal
StandardError=journal

# å®‰å…¨è®¾ç½®
NoNewPrivileges=true
PrivateTmp=true

[Install]
WantedBy=multi-user.target
```

#### 3.4 å¯åŠ¨åç«¯æœåŠ¡
```bash
# é‡è½½systemdé…ç½®
sudo systemctl daemon-reload

# å¯åŠ¨æœåŠ¡
sudo systemctl start cost-backend

# è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl enable cost-backend

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status cost-backend

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u cost-backend -f
```

### 4. éƒ¨ç½²å‰ç«¯åº”ç”¨

#### 4.1 æ„å»ºå‰ç«¯é™æ€èµ„æº
```bash
# è¿›å…¥å‰ç«¯ç›®å½•
cd cost-frontend-react

# å®‰è£…ä¾èµ–
npm install

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build

# æ„å»ºäº§ç‰©ä½ç½®
ls -lh dist/
```

#### 4.2 é…ç½®Nginx

åˆ›å»ºNginxé…ç½®æ–‡ä»¶ `/etc/nginx/conf.d/cost-system.conf`:

```nginx
# ä¸Šæ¸¸åç«¯æœåŠ¡
upstream cost_backend {
    server 127.0.0.1:31943 max_fails=3 fail_timeout=30s;
}

server {
    listen 38443;
    server_name your-domain.com;  # æ›¿æ¢ä¸ºæ‚¨çš„åŸŸåæˆ–IP

    # å‰ç«¯é™æ€èµ„æº
    location / {
        root /var/www/cost-system;
        index index.html;
        try_files $uri $uri/ /index.html;

        # ç¼“å­˜ç­–ç•¥
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf)$ {
            expires 7d;
            add_header Cache-Control "public, immutable";
        }
    }

    # åç«¯APIä»£ç†
    location /api/ {
        proxy_pass http://cost_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # è¶…æ—¶é…ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # ç¼“å†²é…ç½®
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶
    client_max_body_size 100m;

    # æ—¥å¿—
    access_log /var/log/nginx/cost-system-access.log;
    error_log /var/log/nginx/cost-system-error.log;
}

# HTTPSé…ç½®(æ¨èç”Ÿäº§ç¯å¢ƒ)
# server {
#     listen 443 ssl http2;
#     server_name your-domain.com;
#
#     ssl_certificate /etc/nginx/ssl/cost-system.crt;
#     ssl_certificate_key /etc/nginx/ssl/cost-system.key;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#     ssl_prefer_server_ciphers on;
#
#     # ... å…¶ä»–é…ç½®åŒä¸Š ...
# }
```

#### 4.3 éƒ¨ç½²å‰ç«¯æ–‡ä»¶
```bash
# åˆ›å»ºç›®å½•
sudo mkdir -p /var/www/cost-system

# å¤åˆ¶æ„å»ºäº§ç‰©
sudo cp -r cost-frontend-react/dist/* /var/www/cost-system/

# è®¾ç½®æƒé™
sudo chown -R nginx:nginx /var/www/cost-system
sudo chmod -R 755 /var/www/cost-system
```

#### 4.4 å¯åŠ¨Nginx
```bash
# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡è½½é…ç½®
sudo nginx -s reload

# æˆ–é‡å¯Nginx
sudo systemctl restart nginx

# è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl enable nginx
```

---

## ç¯å¢ƒå˜é‡é…ç½®

### å¿…éœ€çš„ç¯å¢ƒå˜é‡

| å˜é‡å | è¯´æ˜ | ç¤ºä¾‹å€¼ | æ˜¯å¦å¿…éœ€ |
|--------|------|--------|---------|
| `SPRING_DATASOURCE_URL` | æ•°æ®åº“è¿æ¥URL | `jdbc:mysql://localhost:3306/cost_system` | âœ… |
| `SPRING_DATASOURCE_USERNAME` | æ•°æ®åº“ç”¨æˆ·å | `cost_admin` | âœ… |
| `SPRING_DATASOURCE_PASSWORD` | æ•°æ®åº“å¯†ç  | `your_password` | âœ… |
| `SPRING_REDIS_HOST` | Redisä¸»æœº | `localhost` | âœ… |
| `SPRING_REDIS_PORT` | Redisç«¯å£ | `6379` | âœ… |
| `SPRING_REDIS_PASSWORD` | Rediså¯†ç  | `your_redis_password` | âœ… |
| `JWT_SECRET` | JWTå¯†é’¥ | `è‡³å°‘32å­—ç¬¦çš„éšæœºå­—ç¬¦ä¸²` | âœ… |
| `JWT_EXPIRATION` | Tokenæœ‰æ•ˆæœŸ(æ¯«ç§’) | `86400000` (24å°æ—¶) | âŒ |
| `JWT_REFRESH_EXPIRATION` | åˆ·æ–°Tokenæœ‰æ•ˆæœŸ | `604800000` (7å¤©) | âŒ |
| `FILE_UPLOAD_PATH` | æ–‡ä»¶ä¸Šä¼ è·¯å¾„ | `/app/uploads` | âŒ |
| `FILE_MAX_SIZE` | æ–‡ä»¶å¤§å°é™åˆ¶ | `100MB` | âŒ |
| `LOG_FILE_PATH` | æ—¥å¿—æ–‡ä»¶è·¯å¾„ | `/app/logs/cost-system.log` | âŒ |
| `SPRING_SECURITY_USER` | ç®¡ç†å‘˜ç”¨æˆ·å | `admin` | âŒ |
| `SPRING_SECURITY_PASSWORD` | ç®¡ç†å‘˜å¯†ç  | `your_admin_password` | âŒ |

### ç”Ÿæˆå®‰å…¨å¯†é’¥

```bash
# ç”Ÿæˆå¼ºå¯†ç 
openssl rand -base64 32

# ç”Ÿæˆ JWT Secretï¼ˆæ¨è64å­—ç¬¦ï¼‰
openssl rand -base64 64

# ç”Ÿæˆéšæœºå­—ç¬¦ä¸²
cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 32 | head -n 1
```

### ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§

1. ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
2. `.env` æ–‡ä»¶ï¼ˆDockeréƒ¨ç½²ï¼‰
3. `application-prod.yml` é»˜è®¤å€¼ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰

---

### 1. å‡†å¤‡æ•°æ®åº“

#### 1.1 åˆ›å»ºæ•°æ®åº“
```bash
# ç™»å½•MySQL
mysql -u root -p

# åˆ›å»ºæ•°æ®åº“
CREATE DATABASE cost_system DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# åˆ›å»ºä¸“ç”¨ç”¨æˆ·(æ¨è)
CREATE USER 'cost_admin'@'%' IDENTIFIED BY 'æ‚¨çš„å¼ºå¯†ç ';
GRANT ALL PRIVILEGES ON cost_system.* TO 'cost_admin'@'%';
FLUSH PRIVILEGES;
```

#### 1.2 æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
```bash
# åˆ‡æ¢åˆ°éƒ¨ç½²ç›®å½•
cd /path/to/cost-system/deploy

# æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
mysql -u cost_admin -p cost_system < mysql-init.sql
```

**éªŒè¯**: æ‰§è¡Œååº”è¯¥çœ‹åˆ°"æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸï¼"æ¶ˆæ¯

#### 1.3 é»˜è®¤è´¦å·
- **ç”¨æˆ·å**: admin
- **å¯†ç **: Admin@123
- **é¦–æ¬¡ç™»å½•åè¯·ç«‹å³ä¿®æ”¹å¯†ç ï¼**

---

### 2. éƒ¨ç½²åç«¯æœåŠ¡

#### 2.1 é…ç½®ç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶
ç¼–è¾‘ `cost-backend/src/main/resources/application-prod.yml`:

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/cost_system?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: cost_admin
    password: æ‚¨çš„æ•°æ®åº“å¯†ç 
    driver-class-name: com.mysql.cj.jdbc.Driver
    
  jpa:
    database-platform: org.hibernate.dialect.MySQL8Dialect
    hibernate:
      ddl-auto: none  # ç”Ÿäº§ç¯å¢ƒç¦æ­¢è‡ªåŠ¨å»ºè¡¨
    show-sql: false   # ç”Ÿäº§ç¯å¢ƒå…³é—­SQLæ—¥å¿—

# JWTé…ç½®
jwt:
  secret: æ‚¨çš„ç”Ÿäº§ç¯å¢ƒJWTå¯†é’¥(è‡³å°‘32å­—ç¬¦,å¼ºéšæœºå­—ç¬¦ä¸²)
  expiration: 86400000  # Tokenæœ‰æ•ˆæœŸ24å°æ—¶

# æ–‡ä»¶ä¸Šä¼ é…ç½®
file:
  upload-dir: /var/cost-system/files
  max-size: 52428800  # 50MB

# æ—¥å¿—é…ç½®
logging:
  level:
    root: INFO
    com.costsystem: INFO
  file:
    name: /var/log/cost-system/application.log
    max-size: 100MB
    max-history: 30
```

#### 2.2 æ‰“åŒ…åç«¯åº”ç”¨
```bash
# è¿›å…¥åç«¯ç›®å½•
cd cost-backend

# ä½¿ç”¨Mavenæ‰“åŒ…
mvn clean package -Dmaven.test.skip=true -Pprod

# æˆ–ä½¿ç”¨Gradle
./gradlew clean build -Pprod
```

ç”Ÿæˆçš„JARåŒ…ä½ç½®: `cost-backend/target/cost-backend-1.0.0.jar`

#### 2.3 éƒ¨ç½²åç«¯æœåŠ¡

##### æ–¹å¼ä¸€: ä½¿ç”¨systemd(æ¨è)
åˆ›å»ºæœåŠ¡æ–‡ä»¶ `/etc/systemd/system/cost-backend.service`:

```ini
[Unit]
Description=Cost Management System Backend
After=syslog.target network.target mysql.service

[Service]
Type=simple
User=cost
WorkingDirectory=/opt/cost-system
ExecStart=/usr/bin/java -Xms2g -Xmx4g -jar /opt/cost-system/cost-backend.jar --spring.profiles.active=prod
SuccessExitStatus=143
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
```

å¯åŠ¨æœåŠ¡:
```bash
# é‡è½½systemdé…ç½®
sudo systemctl daemon-reload

# å¯åŠ¨æœåŠ¡
sudo systemctl start cost-backend

# è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl enable cost-backend

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status cost-backend
```

##### æ–¹å¼äºŒ: ç›´æ¥è¿è¡Œ
```bash
# åå°è¿è¡Œ
nohup java -Xms2g -Xmx4g -jar cost-backend.jar --spring.profiles.active=prod > /var/log/cost-system/backend.log 2>&1 &

# æŸ¥çœ‹è¿›ç¨‹
ps aux | grep cost-backend
```

---

### 3. éƒ¨ç½²å‰ç«¯åº”ç”¨

#### 3.1 æ„å»ºå‰ç«¯é™æ€èµ„æº
```bash
# è¿›å…¥å‰ç«¯ç›®å½•
cd cost-frontend

# å®‰è£…ä¾èµ–
npm install

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build
```

æ„å»ºäº§ç‰©ä½ç½®: `cost-frontend/dist/`

#### 3.2 é…ç½®Nginx

åˆ›å»ºNginxé…ç½®æ–‡ä»¶ `/etc/nginx/conf.d/cost-system.conf`:

```nginx
# ä¸Šæ¸¸åç«¯æœåŠ¡
upstream cost_backend {
    server 127.0.0.1:8080 max_fails=3 fail_timeout=30s;
}

server {
    listen 80;
    server_name your-domain.com;  # æ›¿æ¢ä¸ºæ‚¨çš„åŸŸå

    # å¼ºåˆ¶è·³è½¬HTTPS(å¯é€‰,æ¨èç”Ÿäº§ç¯å¢ƒå¯ç”¨)
    # return 301 https://$server_name$request_uri;

    # å‰ç«¯é™æ€èµ„æº
    location / {
        root /var/www/cost-system;
        index index.html;
        try_files $uri $uri/ /index.html;
        
        # ç¼“å­˜ç­–ç•¥
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf)$ {
            expires 7d;
            add_header Cache-Control "public, immutable";
        }
    }

    # åç«¯APIä»£ç†
    location /api/ {
        proxy_pass http://cost_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # è¶…æ—¶é…ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # ç¼“å†²é…ç½®
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶
    client_max_body_size 50m;

    # æ—¥å¿—
    access_log /var/log/nginx/cost-system-access.log;
    error_log /var/log/nginx/cost-system-error.log;
}

# HTTPSé…ç½®(å¯é€‰,æ¨è)
# server {
#     listen 443 ssl http2;
#     server_name your-domain.com;
#
#     ssl_certificate /etc/nginx/ssl/cost-system.crt;
#     ssl_certificate_key /etc/nginx/ssl/cost-system.key;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#
#     # ... å…¶ä»–é…ç½®åŒä¸Š ...
# }
```

#### 3.3 éƒ¨ç½²å‰ç«¯æ–‡ä»¶
```bash
# åˆ›å»ºç›®å½•
sudo mkdir -p /var/www/cost-system

# å¤åˆ¶æ„å»ºäº§ç‰©
sudo cp -r cost-frontend/dist/* /var/www/cost-system/

# è®¾ç½®æƒé™
sudo chown -R nginx:nginx /var/www/cost-system
sudo chmod -R 755 /var/www/cost-system
```

#### 3.4 å¯åŠ¨Nginx
```bash
# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡è½½é…ç½®
sudo nginx -s reload

# æˆ–é‡å¯Nginx
sudo systemctl restart nginx
```

---

## é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡(å¯é€‰)
æ‚¨å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–é…ç½®:

```bash
# æ•°æ®åº“é…ç½®
export DB_URL=jdbc:mysql://localhost:3306/cost_system
export DB_USERNAME=cost_admin
export DB_PASSWORD=your_password

# JWTé…ç½®
export JWT_SECRET=your_jwt_secret_key
export JWT_EXPIRATION=86400000

# æ–‡ä»¶å­˜å‚¨
export FILE_UPLOAD_DIR=/var/cost-system/files

# å¯åŠ¨åº”ç”¨
java -jar cost-backend.jar --spring.profiles.active=prod
```

### è·¨åŸŸé…ç½®
å¦‚æœå‰åç«¯åˆ†ç¦»éƒ¨ç½²åœ¨ä¸åŒåŸŸå,éœ€è¦é…ç½®CORS:

```yaml
# application-prod.yml
cors:
  allowed-origins: https://your-frontend-domain.com
  allowed-methods: GET,POST,PUT,DELETE,OPTIONS
  allowed-headers: '*'
  allow-credentials: true
```

---

## å¯åŠ¨ä¸åœæ­¢

### Docker éƒ¨ç½²

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose stop

# é‡å¯æ‰€æœ‰æœåŠ¡
docker-compose restart

# é‡å¯å•ä¸ªæœåŠ¡
docker-compose restart backend
docker-compose restart frontend

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨ï¼ˆä¿ç•™æ•°æ®ï¼‰
docker-compose down

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨å’Œæ•°æ®
docker-compose down -v

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f
docker-compose logs -f backend
```

### ä¼ ç»Ÿéƒ¨ç½²

#### åç«¯æœåŠ¡

**ä½¿ç”¨systemd**:
```bash
# å¯åŠ¨
sudo systemctl start cost-backend

# åœæ­¢
sudo systemctl stop cost-backend

# é‡å¯
sudo systemctl restart cost-backend

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status cost-backend

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u cost-backend -f
sudo journalctl -u cost-backend -n 100 --no-pager
```

**ç›´æ¥è¿è¡Œæ–¹å¼**:
```bash
# å¯åŠ¨
nohup java -jar /opt/cost-system/cost-backend.jar --spring.profiles.active=prod > /var/log/cost-system/backend.log 2>&1 &

# æŸ¥æ‰¾è¿›ç¨‹
ps aux | grep cost-backend

# åœæ­¢æœåŠ¡
kill -15 <PID>

# å¼ºåˆ¶åœæ­¢
kill -9 <PID>
```

#### å‰ç«¯æœåŠ¡ï¼ˆNginxï¼‰

```bash
# å¯åŠ¨
sudo systemctl start nginx

# åœæ­¢
sudo systemctl stop nginx

# é‡å¯
sudo systemctl restart nginx

# é‡è½½é…ç½®ï¼ˆä¸ä¸­æ–­æœåŠ¡ï¼‰
sudo nginx -s reload

# æµ‹è¯•é…ç½®
sudo nginx -t

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status nginx
```

---

## ç›‘æ§ä¸æ—¥å¿—

### æ—¥å¿—ä½ç½®

#### Docker éƒ¨ç½²
```bash
# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker-compose logs -f backend
docker-compose logs -f frontend
docker-compose logs -f mysql
docker-compose logs -f redis

# æŸ¥çœ‹æœ€è¿‘100è¡Œ
docker-compose logs --tail=100 backend

# å¯¼å‡ºæ—¥å¿—
docker-compose logs backend > backend.log
```

#### ä¼ ç»Ÿéƒ¨ç½²
| ç»„ä»¶ | æ—¥å¿—è·¯å¾„ |
|------|---------|
| åç«¯åº”ç”¨ | `/var/log/cost-system/application.log` |
| Nginxè®¿é—®æ—¥å¿— | `/var/log/nginx/cost-system-access.log` |
| Nginxé”™è¯¯æ—¥å¿— | `/var/log/nginx/cost-system-error.log` |
| MySQLé”™è¯¯æ—¥å¿— | `/var/log/mysql/error.log` |
| MySQLæ…¢æŸ¥è¯¢æ—¥å¿— | `/var/log/mysql/slow.log` |
| Redisæ—¥å¿— | `/var/log/redis/redis.log` |

### æ—¥å¿—æŸ¥çœ‹å‘½ä»¤

```bash
# å®æ—¶æŸ¥çœ‹åç«¯æ—¥å¿—
tail -f /var/log/cost-system/application.log

# æŸ¥çœ‹æœ€è¿‘çš„é”™è¯¯
grep -i "error" /var/log/cost-system/application.log | tail -n 50

# æŸ¥çœ‹ç‰¹å®šæ—¶é—´æ®µçš„æ—¥å¿—
grep "2026-02-19 10:" /var/log/cost-system/application.log

# æŸ¥çœ‹Nginxè®¿é—®é‡ç»Ÿè®¡
tail -n 1000 /var/log/nginx/cost-system-access.log | awk '{print $1}' | sort | uniq -c | sort -nr

# æŸ¥çœ‹æœ€è€—æ—¶çš„è¯·æ±‚
tail -n 1000 /var/log/nginx/cost-system-access.log | awk '{print $NF, $7}' | sort -nr | head -20
```

### å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥åç«¯æœåŠ¡
curl http://localhost:31943/actuator/health

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
curl http://localhost:31943/actuator/health/db

# æ£€æŸ¥å‰ç«¯æœåŠ¡
curl http://localhost:38443/

# æ£€æŸ¥ MySQL
docker exec cost-mysql mysqladmin ping -h localhost -uroot -p${MYSQL_ROOT_PASSWORD}
# æˆ–ä¼ ç»Ÿéƒ¨ç½²
mysqladmin ping -h localhost -u root -p

# æ£€æŸ¥ Redis
docker exec cost-redis redis-cli -a ${REDIS_PASSWORD} ping
# æˆ–ä¼ ç»Ÿéƒ¨ç½²
redis-cli -a your_password ping
```

### æ€§èƒ½ç›‘æ§

#### ç³»ç»Ÿèµ„æºç›‘æ§
```bash
# æŸ¥çœ‹CPUå’Œå†…å­˜ä½¿ç”¨
top
htop

# Dockerå®¹å™¨èµ„æºä½¿ç”¨
docker stats

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h
du -sh /var/lib/docker/volumes/*

# æŸ¥çœ‹ç½‘ç»œè¿æ¥
netstat -tunlp | grep -E '31943|38443|3306|6379'
```

#### åº”ç”¨ç›‘æ§ï¼ˆæ¨èå·¥å…·ï¼‰
- **åç«¯ç›‘æ§**: Spring Boot Actuator + Prometheus + Grafana
- **æ•°æ®åº“ç›‘æ§**: Percona Monitoring and Management (PMM)
- **å®¹å™¨ç›‘æ§**: cAdvisor + Prometheus + Grafana
- **æ—¥å¿—èšåˆ**: ELK Stack (Elasticsearch + Logstash + Kibana)
- **APM**: SkyWalking / Zipkin

---

## æ•…éšœæ’æŸ¥

### Docker éƒ¨ç½²å¸¸è§é—®é¢˜

#### 1. å®¹å™¨å¯åŠ¨å¤±è´¥

**ç—‡çŠ¶**: å®¹å™¨ä¸æ–­é‡å¯æˆ–é€€å‡º

**æ’æŸ¥æ­¥éª¤**:
```bash
# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker-compose logs backend

# æŸ¥çœ‹å®¹å™¨é€€å‡ºåŸå› 
docker inspect cost-backend | grep -A 10 "State"

# æ£€æŸ¥ç¯å¢ƒå˜é‡
docker exec cost-backend env | grep SPRING
```

**å¸¸è§åŸå› **:
- æ•°æ®åº“è¿æ¥å¤±è´¥ â†’ æ£€æŸ¥ MySQL æ˜¯å¦å°±ç»ª
- Redis è¿æ¥å¤±è´¥ â†’ æ£€æŸ¥ Redis å¯†ç é…ç½®
- ç«¯å£è¢«å ç”¨ â†’ ä¿®æ”¹ docker-compose.yml ç«¯å£æ˜ å°„
- å†…å­˜ä¸è¶³ â†’ å¢åŠ  Docker å†…å­˜é™åˆ¶

#### 2. æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥

**ç—‡çŠ¶**: åç«¯æ—¥å¿—æ˜¾ç¤º SQL æ‰§è¡Œé”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
```bash
# åˆ é™¤æ•°æ®å·é‡æ–°åˆå§‹åŒ–
docker-compose down -v
docker-compose up -d

# æ‰‹åŠ¨æ‰§è¡Œ SQL
docker exec -i cost-mysql mysql -uroot -p${MYSQL_ROOT_PASSWORD} cost_system < deploy/mysql-init.sql

# æ£€æŸ¥æ•°æ®åº“
docker exec -it cost-mysql mysql -uroot -p${MYSQL_ROOT_PASSWORD} -e "SHOW DATABASES;"
docker exec -it cost-mysql mysql -uroot -p${MYSQL_ROOT_PASSWORD} cost_system -e "SHOW TABLES;"
```

#### 3. å‰ç«¯æ— æ³•è®¿é—®åç«¯

**ç—‡çŠ¶**: å‰ç«¯é¡µé¢æ‰“å¼€ï¼Œä½† API è¯·æ±‚å¤±è´¥

**æ’æŸ¥æ­¥éª¤**:
```bash
# æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ
curl http://localhost:31943/actuator/health

# æ£€æŸ¥ç½‘ç»œè¿æ¥
docker network inspect cost-system_cost-network

# æ£€æŸ¥ nginx é…ç½®
docker exec cost-frontend cat /etc/nginx/conf.d/default.conf

# æµ‹è¯•å®¹å™¨é—´é€šä¿¡
docker exec cost-frontend ping backend
```

#### 4. ç«¯å£è¢«å ç”¨

**ç—‡çŠ¶**: å¯åŠ¨å¤±è´¥ï¼Œæç¤ºç«¯å£å·²è¢«ä½¿ç”¨

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
netstat -tunlp | grep 38443  # Linux
lsof -i :38443               # macOS
netstat -ano | findstr "38443"  # Windows

# ä¿®æ”¹ç«¯å£ï¼ˆç¼–è¾‘ .env æ–‡ä»¶ï¼‰
FRONTEND_PORT=38444
BACKEND_PORT=31944

# æˆ–ä¿®æ”¹ docker-compose.yml
ports:
  - "38444:38443"
```

### ä¼ ç»Ÿéƒ¨ç½²å¸¸è§é—®é¢˜

#### 1. åç«¯æœåŠ¡å¯åŠ¨å¤±è´¥

**æ’æŸ¥æ­¥éª¤**:
```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
sudo journalctl -u cost-backend -n 100 --no-pager

# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tlnp | grep 31943

# æ£€æŸ¥é…ç½®æ–‡ä»¶
cat /opt/cost-system/application-prod.yml

# éªŒè¯æ•°æ®åº“è¿æ¥
mysql -u cost_admin -p -e "SELECT 1"

# æ£€æŸ¥ Java ç‰ˆæœ¬
java -version

# æ£€æŸ¥æ–‡ä»¶æƒé™
ls -la /opt/cost-system/
ls -la /var/cost-system/
ls -la /var/log/cost-system/
```

**å¸¸è§åŸå› **:
- æ•°æ®åº“è¿æ¥å¤±è´¥ â†’ æ£€æŸ¥è´¦å·å¯†ç ã€ç½‘ç»œã€é˜²ç«å¢™
- ç«¯å£è¢«å ç”¨ â†’ ä¿®æ”¹é…ç½®æˆ–é‡Šæ”¾ç«¯å£
- JDKç‰ˆæœ¬ä¸åŒ¹é… â†’ éœ€è¦ JDK 17+
- æƒé™ä¸è¶³ â†’ æ£€æŸ¥æ–‡ä»¶å’Œç›®å½•æƒé™
- ç¯å¢ƒå˜é‡æœªåŠ è½½ â†’ æ£€æŸ¥ `/etc/profile.d/cost-system.sh`

#### 2. å‰ç«¯æ— æ³•è®¿é—®

**æ’æŸ¥æ­¥éª¤**:
```bash
# æ£€æŸ¥NginxçŠ¶æ€
sudo systemctl status nginx

# æŸ¥çœ‹Nginxé”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/cost-system-error.log

# æµ‹è¯•Nginxé…ç½®
sudo nginx -t

# æ£€æŸ¥æ–‡ä»¶æƒé™
ls -la /var/www/cost-system

# æ£€æŸ¥é˜²ç«å¢™
sudo firewall-cmd --list-ports  # CentOS/RHEL
sudo ufw status                 # Ubuntu
```

**å¸¸è§åŸå› **:
- Nginxé…ç½®é”™è¯¯ â†’ æ£€æŸ¥è¯­æ³•ï¼Œè¿è¡Œ `nginx -t`
- é™æ€æ–‡ä»¶æƒé™ä¸è¶³ â†’ `chmod 755` å’Œ `chown nginx:nginx`
- é˜²ç«å¢™æ‹¦æˆª â†’ å¼€æ”¾ç«¯å£ 38443
- SELinux é˜»æ­¢ â†’ ä¸´æ—¶å…³é—­æˆ–é…ç½®ç­–ç•¥

#### 3. APIè¯·æ±‚å¤±è´¥ï¼ˆ404/502ï¼‰

**æ’æŸ¥æ­¥éª¤**:
```bash
# æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ
curl http://localhost:31943/actuator/health

# æŸ¥çœ‹Nginx upstreamçŠ¶æ€
curl http://localhost:38443/api/health

# æ£€æŸ¥ä»£ç†é…ç½®
cat /etc/nginx/conf.d/cost-system.conf | grep proxy_pass

# æµ‹è¯•åç«¯ç›´æ¥è®¿é—®
curl -v http://localhost:31943/api/health
```

**å¸¸è§åŸå› **:
- åç«¯æœåŠ¡æœªå¯åŠ¨ â†’ å¯åŠ¨ cost-backend æœåŠ¡
- åå‘ä»£ç†é…ç½®é”™è¯¯ â†’ æ£€æŸ¥ `proxy_pass` åœ°å€
- åç«¯ç«¯å£ä¸åŒ¹é… â†’ ç¡®è®¤åç«¯ç›‘å¬ 31943
- é˜²ç«å¢™é˜»æ­¢å†…éƒ¨é€šä¿¡ â†’ å…è®¸æœ¬åœ°å›ç¯

#### 4. æ•°æ®åº“è¿æ¥æ± è€—å°½

**ç—‡çŠ¶**: åç«¯æ—¥å¿—æ˜¾ç¤º "Connection timed out" æˆ– "Could not get JDBC Connection"

**è§£å†³æ–¹æ¡ˆ**:
```yaml
# è°ƒæ•´è¿æ¥æ± é…ç½® application-prod.yml
spring:
  datasource:
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
      leak-detection-threshold: 60000
```

```bash
# æ£€æŸ¥ MySQL è¿æ¥æ•°
mysql -u root -p -e "SHOW PROCESSLIST;"
mysql -u root -p -e "SHOW STATUS LIKE 'Threads_connected';"

# å¢åŠ  MySQL æœ€å¤§è¿æ¥æ•°
mysql -u root -p -e "SET GLOBAL max_connections = 500;"
```

#### 5. å†…å­˜æº¢å‡ºï¼ˆOOMï¼‰

**ç—‡çŠ¶**: åç«¯æ—¥å¿—æ˜¾ç¤º "OutOfMemoryError" æˆ–æœåŠ¡çªç„¶åœæ­¢

**è§£å†³æ–¹æ¡ˆ**:
```bash
# å¢åŠ JVMå†…å­˜ï¼ˆç¼–è¾‘ systemd æœåŠ¡æ–‡ä»¶ï¼‰
sudo vi /etc/systemd/system/cost-backend.service

# ä¿®æ”¹ JAVA_OPTS
Environment="JAVA_OPTS=-Xms4g -Xmx8g -XX:+UseG1GC -XX:MaxGCPauseMillis=200"

# é‡è½½å¹¶é‡å¯
sudo systemctl daemon-reload
sudo systemctl restart cost-backend

# åˆ†æå †è½¬å‚¨
jmap -dump:format=b,file=/tmp/heap.bin <PID>
jhat /tmp/heap.bin  # æˆ–ä½¿ç”¨ Eclipse MAT
```

#### 6. Redis è¿æ¥å¤±è´¥

**ç—‡çŠ¶**: åç«¯æ—¥å¿—æ˜¾ç¤º "Unable to connect to Redis"

**æ’æŸ¥æ­¥éª¤**:
```bash
# æ£€æŸ¥ Redis çŠ¶æ€
sudo systemctl status redis

# æµ‹è¯• Redis è¿æ¥
redis-cli -a your_password ping

# æ£€æŸ¥ Redis é…ç½®
cat /etc/redis/redis.conf | grep -E "bind|requirepass|port"

# æ£€æŸ¥é˜²ç«å¢™
sudo firewall-cmd --list-ports
```

---

## å®‰å…¨åŠ å›ºå»ºè®®

### 1. æ•°æ®åº“å®‰å…¨
```bash
# ç¦æ­¢rootè¿œç¨‹ç™»å½•
mysql -u root -p -e "DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');"
mysql -u root -p -e "FLUSH PRIVILEGES;"

# åˆ é™¤åŒ¿åç”¨æˆ·
mysql -u root -p -e "DELETE FROM mysql.user WHERE User='';"

# åˆ é™¤testæ•°æ®åº“
mysql -u root -p -e "DROP DATABASE IF EXISTS test;"

# å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—
mysql -u root -p -e "SET GLOBAL slow_query_log = 'ON';"
mysql -u root -p -e "SET GLOBAL long_query_time = 2;"
```

### 2. åº”ç”¨å®‰å…¨
- âœ… ä¿®æ”¹é»˜è®¤ç®¡ç†å‘˜å¯†ç 
- âœ… å¯ç”¨HTTPSï¼ˆSSLè¯ä¹¦ï¼‰
- âœ… é…ç½®å¼ºJWTå¯†é’¥ï¼ˆéšæœºç”Ÿæˆï¼Œè‡³å°‘64å­—ç¬¦ï¼‰
- âœ… é™åˆ¶æ–‡ä»¶ä¸Šä¼ å¤§å°å’Œç±»å‹
- âœ… å®šæœŸæ›´æ–°ä¾èµ–ç‰ˆæœ¬
- âœ… å¯ç”¨ CORS ç™½åå•
- âœ… é…ç½® Rate Limitingï¼ˆé™æµï¼‰

### 3. æœåŠ¡å™¨å®‰å…¨
```bash
# é…ç½®é˜²ç«å¢™
sudo firewall-cmd --permanent --add-port=38443/tcp
sudo firewall-cmd --permanent --add-port=31943/tcp
sudo firewall-cmd --reload

# ç¦ç”¨ä¸å¿…è¦çš„ç«¯å£
sudo firewall-cmd --permanent --remove-port=3306/tcp  # å¦‚æœä¸éœ€è¦å¤–éƒ¨è®¿é—®MySQL
sudo firewall-cmd --permanent --remove-port=6379/tcp  # å¦‚æœä¸éœ€è¦å¤–éƒ¨è®¿é—®Redis

# ä½¿ç”¨érootç”¨æˆ·è¿è¡ŒæœåŠ¡
sudo useradd -r -s /bin/false cost

# å®šæœŸæ›´æ–°ç³»ç»Ÿ
sudo yum update -y  # CentOS/RHEL
sudo apt-get update && sudo apt-get upgrade -y  # Ubuntu

# å®‰è£… fail2ban é˜²æ­¢æš´åŠ›ç ´è§£
sudo yum install -y fail2ban
sudo systemctl start fail2ban
sudo systemctl enable fail2ban
```

### 4. HTTPS é…ç½®

```bash
# ä½¿ç”¨ Let's Encrypt å…è´¹è¯ä¹¦
sudo yum install -y certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com

# æˆ–ä½¿ç”¨è‡ªç­¾åè¯ä¹¦ï¼ˆä»…æµ‹è¯•ï¼‰
sudo mkdir -p /etc/nginx/ssl
sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout /etc/nginx/ssl/cost-system.key \
  -out /etc/nginx/ssl/cost-system.crt
```

---

## å¤‡ä»½ä¸æ¢å¤

### æ•°æ®åº“å¤‡ä»½

#### è‡ªåŠ¨å¤‡ä»½è„šæœ¬
```bash
# åˆ›å»ºå¤‡ä»½è„šæœ¬
sudo vi /usr/local/bin/backup-cost-system.sh
```

```bash
#!/bin/bash
# å»ºææˆæœ¬ç®¡ç†ç³»ç»Ÿæ•°æ®åº“å¤‡ä»½è„šæœ¬

BACKUP_DIR=/backup/mysql
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME=cost_system
DB_USER=cost_admin
DB_PASS=your_password

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®åº“
mysqldump -u $DB_USER -p$DB_PASS $DB_NAME | gzip > $BACKUP_DIR/${DB_NAME}_${DATE}.sql.gz

# ä¿ç•™æœ€è¿‘30å¤©å¤‡ä»½
find $BACKUP_DIR -name "*.sql.gz" -mtime +30 -delete

# è®°å½•æ—¥å¿—
echo "$(date): Backup completed - ${DB_NAME}_${DATE}.sql.gz" >> /var/log/cost-system/backup.log
```

```bash
# è®¾ç½®æƒé™
sudo chmod +x /usr/local/bin/backup-cost-system.sh

# æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½ï¼‰
sudo crontab -e
0 2 * * * /usr/local/bin/backup-cost-system.sh
```

#### Docker æ•°æ®åº“å¤‡ä»½
```bash
# å¤‡ä»½
docker exec cost-mysql mysqldump -uroot -p${MYSQL_ROOT_PASSWORD} cost_system | gzip > backup_$(date +%Y%m%d_%H%M%S).sql.gz

# æ¢å¤
gunzip < backup_20260219_020000.sql.gz | docker exec -i cost-mysql mysql -uroot -p${MYSQL_ROOT_PASSWORD} cost_system
```

### æ–‡ä»¶å¤‡ä»½

```bash
# å¤‡ä»½ä¸Šä¼ çš„æ–‡ä»¶
tar -czf /backup/files/cost-files-$(date +%Y%m%d).tar.gz /var/cost-system/files/

# Docker å·å¤‡ä»½
docker run --rm -v cost-system_backend-uploads:/data -v $(pwd):/backup alpine tar czf /backup/uploads-backup.tar.gz /data
```

### æ¢å¤æ•°æ®åº“

```bash
# ä¼ ç»Ÿéƒ¨ç½²æ¢å¤
gunzip < cost_system_20260219_020000.sql.gz | mysql -u cost_admin -p cost_system

# Docker éƒ¨ç½²æ¢å¤
gunzip < backup.sql.gz | docker exec -i cost-mysql mysql -uroot -p${MYSQL_ROOT_PASSWORD} cost_system
```

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®åº“ä¼˜åŒ–

```sql
-- å®šæœŸä¼˜åŒ–è¡¨
OPTIMIZE TABLE cost_line_item;
OPTIMIZE TABLE cost_project;
OPTIMIZE TABLE cost_form_version;

-- åˆ†ææ…¢æŸ¥è¯¢
SELECT * FROM mysql.slow_log ORDER BY query_time DESC LIMIT 10;

-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SHOW INDEX FROM cost_line_item;

-- åˆ†æè¡¨
ANALYZE TABLE cost_line_item;
```

### 2. åº”ç”¨ä¼˜åŒ–

```yaml
# application-prod.yml
spring:
  # å¯ç”¨æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–
  datasource:
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000

  # å¯ç”¨ JPA äºŒçº§ç¼“å­˜
  jpa:
    properties:
      hibernate:
        cache:
          use_second_level_cache: true
          region:
            factory_class: org.hibernate.cache.jcache.JCacheRegionFactory
```

### 3. Nginx ä¼˜åŒ–

```nginx
# å¯ç”¨ Gzip å‹ç¼©
gzip on;
gzip_comp_level 5;
gzip_min_length 256;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

# å¯ç”¨ç¼“å­˜
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=api_cache:10m max_size=1g inactive=60m;

location /api/ {
    proxy_cache api_cache;
    proxy_cache_valid 200 5m;
    proxy_cache_key "$scheme$request_method$host$request_uri";
}

# è¿æ¥ä¼˜åŒ–
keepalive_timeout 65;
keepalive_requests 100;

# å·¥ä½œè¿›ç¨‹æ•°
worker_processes auto;
worker_connections 1024;
```

### 4. JVM ä¼˜åŒ–

```bash
# ä½¿ç”¨ G1 åƒåœ¾å›æ”¶å™¨
JAVA_OPTS="-Xms4g -Xmx8g \
  -XX:+UseG1GC \
  -XX:MaxGCPauseMillis=200 \
  -XX:G1HeapRegionSize=16m \
  -XX:+ParallelRefProcEnabled \
  -XX:+HeapDumpOnOutOfMemoryError \
  -XX:HeapDumpPath=/var/log/cost-system/heap_dump.hprof"
```

---

## è”ç³»æ”¯æŒ

å¦‚é‡åˆ°éƒ¨ç½²é—®é¢˜ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒå›¢é˜Ÿå¹¶æä¾›:
- é”™è¯¯æ—¥å¿—ï¼ˆapplication.log æˆ– docker-compose logsï¼‰
- ç³»ç»Ÿä¿¡æ¯ï¼ˆOSç‰ˆæœ¬ã€JDKç‰ˆæœ¬ã€æ•°æ®åº“ç‰ˆæœ¬ï¼‰
- é—®é¢˜å¤ç°æ­¥éª¤
- é…ç½®æ–‡ä»¶ï¼ˆè„±æ•åï¼‰

---

**éƒ¨ç½²ç‰ˆæœ¬**: v2.0.0
**æœ€åæ›´æ–°**: 2026-02-19
