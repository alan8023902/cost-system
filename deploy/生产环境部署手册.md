# å»ºææˆæœ¬ç®¡ç†ç³»ç»Ÿ - ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ‰‹å†Œ

## ğŸ“‹ ç›®å½•
- [ç³»ç»Ÿè¦æ±‚](#ç³»ç»Ÿè¦æ±‚)
- [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
- [éƒ¨ç½²æ­¥éª¤](#éƒ¨ç½²æ­¥éª¤)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [å¯åŠ¨ä¸åœæ­¢](#å¯åŠ¨ä¸åœæ­¢)
- [ç›‘æ§ä¸æ—¥å¿—](#ç›‘æ§ä¸æ—¥å¿—)
- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## ç³»ç»Ÿè¦æ±‚

### æœåŠ¡å™¨é…ç½®å»ºè®®
- **CPU**: 4æ ¸åŠä»¥ä¸Š
- **å†…å­˜**: 8GBåŠä»¥ä¸Š
- **ç¡¬ç›˜**: 100GBåŠä»¥ä¸Š(SSDæ¨è)
- **æ“ä½œç³»ç»Ÿ**: Linux(æ¨èCentOS 7+/Ubuntu 20.04+) æˆ– Windows Server 2019+

### è½¯ä»¶ä¾èµ–
| è½¯ä»¶ | ç‰ˆæœ¬è¦æ±‚ | è¯´æ˜ |
|------|---------|------|
| JDK | 17+ | åç«¯è¿è¡Œç¯å¢ƒ |
| Node.js | 18+ | å‰ç«¯æ„å»ºå·¥å…· |
| MySQL | 8.0+ | ç”Ÿäº§æ•°æ®åº“ |
| Nginx | 1.18+ | åå‘ä»£ç†ä¸é™æ€èµ„æºæœåŠ¡ |

---

## éƒ¨ç½²æ¶æ„

```
[å®¢æˆ·ç«¯æµè§ˆå™¨]
      â†“
[Nginx :80/:443]
      â†“
   â”Œâ”€â”€â”´â”€â”€â”
   â†“     â†“
[å‰ç«¯é™æ€èµ„æº]  [åç«¯API :8080]
                    â†“
                [MySQL :3306]
```

### ç«¯å£åˆ†é…
- **Nginx**: 80(HTTP) / 443(HTTPS)
- **åç«¯**: 8080(å¯è°ƒæ•´)
- **MySQL**: 3306
- **å‰ç«¯å¼€å‘æœåŠ¡å™¨**: 5173(ç”Ÿäº§ç¯å¢ƒä¸éœ€è¦)

---

## éƒ¨ç½²æ­¥éª¤

### 1. å‡†å¤‡æ•°æ®åº“

#### 1.1 åˆ›å»ºæ•°æ®åº“
```bash
# ç™»å½•MySQL
mysql -u root -p

# åˆ›å»ºæ•°æ®åº“
CREATE DATABASE cost_system DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# åˆ›å»ºä¸“ç”¨ç”¨æˆ·(æ¨è)
CREATE USER 'cost_admin'@'%' IDENTIFIED BY 'æ‚¨çš„å¼ºå¯†ç ';
GRANT ALL PRIVILEGES ON cost_system.* TO 'cost_admin'@'%';
FLUSH PRIVILEGES;
```

#### 1.2 æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
```bash
# åˆ‡æ¢åˆ°éƒ¨ç½²ç›®å½•
cd /path/to/cost-system/deploy

# æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
mysql -u cost_admin -p cost_system < mysql-init.sql
```

**éªŒè¯**: æ‰§è¡Œååº”è¯¥çœ‹åˆ°"æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸï¼"æ¶ˆæ¯

#### 1.3 é»˜è®¤è´¦å·
- **ç”¨æˆ·å**: admin
- **å¯†ç **: Admin@123
- **é¦–æ¬¡ç™»å½•åè¯·ç«‹å³ä¿®æ”¹å¯†ç ï¼**

---

### 2. éƒ¨ç½²åç«¯æœåŠ¡

#### 2.1 é…ç½®ç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶
ç¼–è¾‘ `cost-backend/src/main/resources/application-prod.yml`:

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/cost_system?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: cost_admin
    password: æ‚¨çš„æ•°æ®åº“å¯†ç 
    driver-class-name: com.mysql.cj.jdbc.Driver
    
  jpa:
    database-platform: org.hibernate.dialect.MySQL8Dialect
    hibernate:
      ddl-auto: none  # ç”Ÿäº§ç¯å¢ƒç¦æ­¢è‡ªåŠ¨å»ºè¡¨
    show-sql: false   # ç”Ÿäº§ç¯å¢ƒå…³é—­SQLæ—¥å¿—

# JWTé…ç½®
jwt:
  secret: æ‚¨çš„ç”Ÿäº§ç¯å¢ƒJWTå¯†é’¥(è‡³å°‘32å­—ç¬¦,å¼ºéšæœºå­—ç¬¦ä¸²)
  expiration: 86400000  # Tokenæœ‰æ•ˆæœŸ24å°æ—¶

# æ–‡ä»¶ä¸Šä¼ é…ç½®
file:
  upload-dir: /var/cost-system/files
  max-size: 52428800  # 50MB

# æ—¥å¿—é…ç½®
logging:
  level:
    root: INFO
    com.costsystem: INFO
  file:
    name: /var/log/cost-system/application.log
    max-size: 100MB
    max-history: 30
```

#### 2.2 æ‰“åŒ…åç«¯åº”ç”¨
```bash
# è¿›å…¥åç«¯ç›®å½•
cd cost-backend

# ä½¿ç”¨Mavenæ‰“åŒ…
mvn clean package -Dmaven.test.skip=true -Pprod

# æˆ–ä½¿ç”¨Gradle
./gradlew clean build -Pprod
```

ç”Ÿæˆçš„JARåŒ…ä½ç½®: `cost-backend/target/cost-backend-1.0.0.jar`

#### 2.3 éƒ¨ç½²åç«¯æœåŠ¡

##### æ–¹å¼ä¸€: ä½¿ç”¨systemd(æ¨è)
åˆ›å»ºæœåŠ¡æ–‡ä»¶ `/etc/systemd/system/cost-backend.service`:

```ini
[Unit]
Description=Cost Management System Backend
After=syslog.target network.target mysql.service

[Service]
Type=simple
User=cost
WorkingDirectory=/opt/cost-system
ExecStart=/usr/bin/java -Xms2g -Xmx4g -jar /opt/cost-system/cost-backend.jar --spring.profiles.active=prod
SuccessExitStatus=143
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
```

å¯åŠ¨æœåŠ¡:
```bash
# é‡è½½systemdé…ç½®
sudo systemctl daemon-reload

# å¯åŠ¨æœåŠ¡
sudo systemctl start cost-backend

# è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl enable cost-backend

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status cost-backend
```

##### æ–¹å¼äºŒ: ç›´æ¥è¿è¡Œ
```bash
# åå°è¿è¡Œ
nohup java -Xms2g -Xmx4g -jar cost-backend.jar --spring.profiles.active=prod > /var/log/cost-system/backend.log 2>&1 &

# æŸ¥çœ‹è¿›ç¨‹
ps aux | grep cost-backend
```

---

### 3. éƒ¨ç½²å‰ç«¯åº”ç”¨

#### 3.1 æ„å»ºå‰ç«¯é™æ€èµ„æº
```bash
# è¿›å…¥å‰ç«¯ç›®å½•
cd cost-frontend

# å®‰è£…ä¾èµ–
npm install

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build
```

æ„å»ºäº§ç‰©ä½ç½®: `cost-frontend/dist/`

#### 3.2 é…ç½®Nginx

åˆ›å»ºNginxé…ç½®æ–‡ä»¶ `/etc/nginx/conf.d/cost-system.conf`:

```nginx
# ä¸Šæ¸¸åç«¯æœåŠ¡
upstream cost_backend {
    server 127.0.0.1:8080 max_fails=3 fail_timeout=30s;
}

server {
    listen 80;
    server_name your-domain.com;  # æ›¿æ¢ä¸ºæ‚¨çš„åŸŸå

    # å¼ºåˆ¶è·³è½¬HTTPS(å¯é€‰,æ¨èç”Ÿäº§ç¯å¢ƒå¯ç”¨)
    # return 301 https://$server_name$request_uri;

    # å‰ç«¯é™æ€èµ„æº
    location / {
        root /var/www/cost-system;
        index index.html;
        try_files $uri $uri/ /index.html;
        
        # ç¼“å­˜ç­–ç•¥
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf)$ {
            expires 7d;
            add_header Cache-Control "public, immutable";
        }
    }

    # åç«¯APIä»£ç†
    location /api/ {
        proxy_pass http://cost_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # è¶…æ—¶é…ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # ç¼“å†²é…ç½®
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶
    client_max_body_size 50m;

    # æ—¥å¿—
    access_log /var/log/nginx/cost-system-access.log;
    error_log /var/log/nginx/cost-system-error.log;
}

# HTTPSé…ç½®(å¯é€‰,æ¨è)
# server {
#     listen 443 ssl http2;
#     server_name your-domain.com;
#
#     ssl_certificate /etc/nginx/ssl/cost-system.crt;
#     ssl_certificate_key /etc/nginx/ssl/cost-system.key;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#
#     # ... å…¶ä»–é…ç½®åŒä¸Š ...
# }
```

#### 3.3 éƒ¨ç½²å‰ç«¯æ–‡ä»¶
```bash
# åˆ›å»ºç›®å½•
sudo mkdir -p /var/www/cost-system

# å¤åˆ¶æ„å»ºäº§ç‰©
sudo cp -r cost-frontend/dist/* /var/www/cost-system/

# è®¾ç½®æƒé™
sudo chown -R nginx:nginx /var/www/cost-system
sudo chmod -R 755 /var/www/cost-system
```

#### 3.4 å¯åŠ¨Nginx
```bash
# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡è½½é…ç½®
sudo nginx -s reload

# æˆ–é‡å¯Nginx
sudo systemctl restart nginx
```

---

## é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡(å¯é€‰)
æ‚¨å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–é…ç½®:

```bash
# æ•°æ®åº“é…ç½®
export DB_URL=jdbc:mysql://localhost:3306/cost_system
export DB_USERNAME=cost_admin
export DB_PASSWORD=your_password

# JWTé…ç½®
export JWT_SECRET=your_jwt_secret_key
export JWT_EXPIRATION=86400000

# æ–‡ä»¶å­˜å‚¨
export FILE_UPLOAD_DIR=/var/cost-system/files

# å¯åŠ¨åº”ç”¨
java -jar cost-backend.jar --spring.profiles.active=prod
```

### è·¨åŸŸé…ç½®
å¦‚æœå‰åç«¯åˆ†ç¦»éƒ¨ç½²åœ¨ä¸åŒåŸŸå,éœ€è¦é…ç½®CORS:

```yaml
# application-prod.yml
cors:
  allowed-origins: https://your-frontend-domain.com
  allowed-methods: GET,POST,PUT,DELETE,OPTIONS
  allowed-headers: '*'
  allow-credentials: true
```

---

## å¯åŠ¨ä¸åœæ­¢

### åç«¯æœåŠ¡

#### ä½¿ç”¨systemd
```bash
# å¯åŠ¨
sudo systemctl start cost-backend

# åœæ­¢
sudo systemctl stop cost-backend

# é‡å¯
sudo systemctl restart cost-backend

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status cost-backend

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u cost-backend -f
```

#### ç›´æ¥è¿è¡Œæ–¹å¼
```bash
# æŸ¥æ‰¾è¿›ç¨‹
ps aux | grep cost-backend

# åœæ­¢æœåŠ¡(æ‰¾åˆ°PIDå)
kill -15 <PID>
```

### Nginx
```bash
# å¯åŠ¨
sudo systemctl start nginx

# åœæ­¢
sudo systemctl stop nginx

# é‡å¯
sudo systemctl restart nginx

# é‡è½½é…ç½®(ä¸ä¸­æ–­æœåŠ¡)
sudo nginx -s reload

# æµ‹è¯•é…ç½®
sudo nginx -t
```

---

## ç›‘æ§ä¸æ—¥å¿—

### æ—¥å¿—ä½ç½®
| ç»„ä»¶ | æ—¥å¿—è·¯å¾„ |
|------|---------|
| åç«¯åº”ç”¨ | `/var/log/cost-system/application.log` |
| Nginxè®¿é—®æ—¥å¿— | `/var/log/nginx/cost-system-access.log` |
| Nginxé”™è¯¯æ—¥å¿— | `/var/log/nginx/cost-system-error.log` |
| MySQLæ…¢æŸ¥è¯¢æ—¥å¿— | `/var/log/mysql/slow.log` |

### æ—¥å¿—æŸ¥çœ‹å‘½ä»¤
```bash
# å®æ—¶æŸ¥çœ‹åç«¯æ—¥å¿—
tail -f /var/log/cost-system/application.log

# æŸ¥çœ‹æœ€è¿‘çš„é”™è¯¯
grep -i "error" /var/log/cost-system/application.log | tail -n 50

# æŸ¥çœ‹Nginxè®¿é—®é‡
tail -n 1000 /var/log/nginx/cost-system-access.log | awk '{print $1}' | sort | uniq -c | sort -nr
```

### å¥åº·æ£€æŸ¥
```bash
# æ£€æŸ¥åç«¯æœåŠ¡
curl http://localhost:8080/api/health

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
curl http://localhost:8080/api/health/db

# æ£€æŸ¥å‰ç«¯æœåŠ¡
curl http://localhost/
```

### æ€§èƒ½ç›‘æ§(æ¨èå·¥å…·)
- **åç«¯ç›‘æ§**: Spring Boot Actuator + Prometheus + Grafana
- **æ•°æ®åº“ç›‘æ§**: Percona Monitoring and Management(PMM)
- **æœåŠ¡å™¨ç›‘æ§**: Zabbix / Nagios

---

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. åç«¯æœåŠ¡å¯åŠ¨å¤±è´¥
**æ’æŸ¥æ­¥éª¤**:
```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
sudo journalctl -u cost-backend -n 100 --no-pager

# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tlnp | grep 8080

# æ£€æŸ¥é…ç½®æ–‡ä»¶
cat /opt/cost-system/application-prod.yml

# éªŒè¯æ•°æ®åº“è¿æ¥
mysql -u cost_admin -p -e "SELECT 1"
```

**å¸¸è§åŸå› **:
- æ•°æ®åº“è¿æ¥å¤±è´¥(æ£€æŸ¥è´¦å·å¯†ç ã€ç½‘ç»œ)
- ç«¯å£è¢«å ç”¨(ä¿®æ”¹é…ç½®æˆ–é‡Šæ”¾ç«¯å£)
- JDKç‰ˆæœ¬ä¸åŒ¹é…(éœ€è¦JDK 17+)
- æƒé™ä¸è¶³(æ£€æŸ¥æ–‡ä»¶å’Œç›®å½•æƒé™)

#### 2. å‰ç«¯æ— æ³•è®¿é—®
**æ’æŸ¥æ­¥éª¤**:
```bash
# æ£€æŸ¥NginxçŠ¶æ€
sudo systemctl status nginx

# æŸ¥çœ‹Nginxé”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/cost-system-error.log

# æµ‹è¯•Nginxé…ç½®
sudo nginx -t

# æ£€æŸ¥æ–‡ä»¶æƒé™
ls -la /var/www/cost-system
```

**å¸¸è§åŸå› **:
- Nginxé…ç½®é”™è¯¯(æ£€æŸ¥è¯­æ³•)
- é™æ€æ–‡ä»¶æƒé™ä¸è¶³(chmod/chown)
- é˜²ç«å¢™æ‹¦æˆª(æ£€æŸ¥iptables/firewalld)

#### 3. APIè¯·æ±‚å¤±è´¥(404/502)
**æ’æŸ¥æ­¥éª¤**:
```bash
# æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ
curl http://localhost:8080/api/health

# æŸ¥çœ‹Nginx upstreamçŠ¶æ€
curl http://localhost/api/health

# æ£€æŸ¥ä»£ç†é…ç½®
cat /etc/nginx/conf.d/cost-system.conf | grep proxy_pass
```

**å¸¸è§åŸå› **:
- åç«¯æœåŠ¡æœªå¯åŠ¨
- åå‘ä»£ç†é…ç½®é”™è¯¯
- åç«¯ç«¯å£ä¸åŒ¹é…

#### 4. æ•°æ®åº“è¿æ¥æ± è€—å°½
**ç—‡çŠ¶**: åç«¯æ—¥å¿—æ˜¾ç¤º "Connection timed out"

**è§£å†³æ–¹æ¡ˆ**:
```yaml
# è°ƒæ•´è¿æ¥æ± é…ç½® application-prod.yml
spring:
  datasource:
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
```

#### 5. å†…å­˜æº¢å‡º(OOM)
**ç—‡çŠ¶**: åç«¯æ—¥å¿—æ˜¾ç¤º "OutOfMemoryError"

**è§£å†³æ–¹æ¡ˆ**:
```bash
# å¢åŠ JVMå†…å­˜
ExecStart=/usr/bin/java -Xms4g -Xmx8g -jar cost-backend.jar

# åˆ†æå †è½¬å‚¨
jmap -dump:format=b,file=heap.bin <PID>
```

---

## å®‰å…¨åŠ å›ºå»ºè®®

### 1. æ•°æ®åº“å®‰å…¨
- âœ… ç¦æ­¢rootè¿œç¨‹ç™»å½•
- âœ… å®šæœŸå¤‡ä»½æ•°æ®åº“
- âœ… å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—
- âœ… é™åˆ¶æ•°æ®åº“è´¦å·æƒé™

### 2. åº”ç”¨å®‰å…¨
- âœ… ä¿®æ”¹é»˜è®¤ç®¡ç†å‘˜å¯†ç 
- âœ… å¯ç”¨HTTPS(SSLè¯ä¹¦)
- âœ… é…ç½®å¼ºJWTå¯†é’¥(éšæœºç”Ÿæˆ)
- âœ… é™åˆ¶æ–‡ä»¶ä¸Šä¼ å¤§å°å’Œç±»å‹
- âœ… å®šæœŸæ›´æ–°ä¾èµ–ç‰ˆæœ¬

### 3. æœåŠ¡å™¨å®‰å…¨
- âœ… é…ç½®é˜²ç«å¢™è§„åˆ™
- âœ… ç¦ç”¨ä¸å¿…è¦çš„ç«¯å£
- âœ… ä½¿ç”¨érootç”¨æˆ·è¿è¡ŒæœåŠ¡
- âœ… å®šæœŸæ›´æ–°ç³»ç»Ÿè¡¥ä¸
- âœ… é…ç½®fail2bané˜²æ­¢æš´åŠ›ç ´è§£

---

## å¤‡ä»½ä¸æ¢å¤

### æ•°æ®åº“å¤‡ä»½
```bash
# æ¯æ—¥è‡ªåŠ¨å¤‡ä»½è„šæœ¬
#!/bin/bash
BACKUP_DIR=/backup/mysql
DATE=$(date +%Y%m%d_%H%M%S)
mysqldump -u cost_admin -p'your_password' cost_system | gzip > $BACKUP_DIR/cost_system_$DATE.sql.gz

# ä¿ç•™æœ€è¿‘30å¤©å¤‡ä»½
find $BACKUP_DIR -name "*.sql.gz" -mtime +30 -delete
```

### æ¢å¤æ•°æ®åº“
```bash
# è§£å‹å¹¶æ¢å¤
gunzip < cost_system_20260208_120000.sql.gz | mysql -u cost_admin -p cost_system
```

### æ–‡ä»¶å¤‡ä»½
```bash
# å¤‡ä»½ä¸Šä¼ çš„æ–‡ä»¶
tar -czf /backup/files/cost-files-$(date +%Y%m%d).tar.gz /var/cost-system/files/
```

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®åº“ä¼˜åŒ–
```sql
-- å®šæœŸä¼˜åŒ–è¡¨
OPTIMIZE TABLE cost_line_item;

-- åˆ†ææ…¢æŸ¥è¯¢
SELECT * FROM mysql.slow_log ORDER BY query_time DESC LIMIT 10;
```

### 2. åº”ç”¨ä¼˜åŒ–
- å¯ç”¨Redisç¼“å­˜(æŒ‡æ ‡å€¼ã€ç”¨æˆ·ä¿¡æ¯)
- å¯ç”¨æ•°æ®åº“è¿æ¥æ± 
- å¯ç”¨Gzipå‹ç¼©
- ä½¿ç”¨CDNåŠ é€Ÿé™æ€èµ„æº

### 3. Nginxä¼˜åŒ–
```nginx
# å¯ç”¨Gzip
gzip on;
gzip_comp_level 5;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

# å¯ç”¨ç¼“å­˜
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=api_cache:10m max_size=1g inactive=60m;
```

---

## è”ç³»æ”¯æŒ
å¦‚é‡åˆ°éƒ¨ç½²é—®é¢˜,è¯·è”ç³»æŠ€æœ¯æ”¯æŒå›¢é˜Ÿå¹¶æä¾›:
- é”™è¯¯æ—¥å¿—(application.log)
- ç³»ç»Ÿä¿¡æ¯(OSç‰ˆæœ¬ã€JDKç‰ˆæœ¬ã€æ•°æ®åº“ç‰ˆæœ¬)
- é—®é¢˜å¤ç°æ­¥éª¤

---

**éƒ¨ç½²ç‰ˆæœ¬**: v1.0.0  
**æœ€åæ›´æ–°**: 2026-02-08
