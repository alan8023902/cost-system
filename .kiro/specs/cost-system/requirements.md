# 工程成本计划与税务计控系统 - 需求规格书

## 1. 项目目标

构建一个可在 PC/平板/手机使用的工程成本计划与税务计控系统，替代客户 Excel 维护方式，实现：

- 客户仅需修改部分数据即可自动计算汇总指标
- 明细行可增加（行无限扩展），材料类别可增减（类型可扩展）
- 项目隔离：不同项目数据完全隔离（权限、文件、审批、导出都隔离）
- 支持线上审批与电子盖章，形成可归档的签发版本
- 支持导入/导出（Excel、PDF）
- 数据准确、可追溯、可审计

## 2. 功能需求（一期范围）

### 2.1 基础能力

- 登录/鉴权（JWT access/refresh，支持禁用/改密立即失效）
- 权限（系统级 + 项目级 + 动作级权限）
- 项目管理（创建、成员、角色分配、隔离）
- 成本计划版本管理（草稿/审批/签发/归档）

### 2.2 明细与扩展

明细模块固定列，但行可无限扩展

明细模块包括：
- 物资（材料/设备/装材/土建等，可扩展类别）
- 分包（可扩展类型）
- 费用（可扩展类型）

支持功能：
- 批量粘贴/批量保存
- 校验（必填、范围、税率白名单等）

### 2.3 计算与追溯

- 后端规则引擎计算（替代 Excel 公式）
- 汇总指标只读展示
- 每个指标必须可追溯：
  - 使用了哪些规则
  - 命中了哪些明细行（贡献值）
  - 中间值与最终值（可选）

### 2.4 审批与签章

- 审批流（退回、加签/转交可选）
- 审批通过后可签发冻结（Issued）
- Issued 版本允许导出 Excel/PDF
- PDF 盖章（电子章）并记录 hash 防篡改

### 2.5 导入导出

- Excel 导入（仅 Draft 可导入）
- Excel 导出（版式与客户旧表一致）
- PDF 导出（用于签章/归档）
- 文件下载必须鉴权（项目成员 + 权限）

### 2.6 审计与留痕

- 金额字段变更必须记录字段级 diff
- 提交/审批/签发/导出/下载/盖章必须记录审计日志

## 3. 关键约束（验收硬标准）

### 3.1 项目隔离

- 非项目成员访问任何项目/版本/文件：必须 403
- 通过 versionId 访问时必须后端解析 projectId 并校验成员关系
- 导出与下载同样执行项目权限校验

### 3.2 版本状态机（硬约束）

状态流转：`DRAFT → IN_APPROVAL → APPROVED → ISSUED → ARCHIVED`

任何写操作仅允许 DRAFT：
- 明细新增/更新/删除
- 导入
- 批量更新

非 DRAFT 写操作必须拒绝（建议 HTTP 409）

### 3.3 可扩展性

- 新增材料类别：仅通过字典/模板配置生效，不改代码、不改表
- 新增明细字段：写 ext_json，不改表
- 新增指标：新增规则配置即可生效，不改代码主流程

## 4. 角色与权限

### 4.1 系统级角色

- **SYSTEM_ADMIN**：模板/字典/流程/规则配置与发布
- **SECURITY_ADMIN**：用户、角色、权限管理

### 4.2 项目级角色

- **PROJECT_ADMIN**：项目配置、成员管理
- **EDITOR**：填报草稿、提交
- **REVIEWER**：复核（可编辑/可退回，按制度）
- **APPROVER**：审批
- **SEAL_ADMIN**：签发/盖章
- **VIEWER**：只读

### 4.3 动作级权限（perm_code）

**版本操作：**
- VERSION_CREATE / VERSION_EDIT / VERSION_SUBMIT / VERSION_WITHDRAW / VERSION_ISSUE / VERSION_ARCHIVE

**明细操作：**
- ITEM_READ / ITEM_WRITE / ITEM_DELETE / ITEM_IMPORT / ITEM_EXPORT

**指标操作：**
- INDICATOR_READ / TRACE_READ

**审批操作：**
- TASK_APPROVE / TASK_REJECT / TASK_TRANSFER

**文件操作：**
- SEAL_EXECUTE / FILE_DOWNLOAD

## 5. 验收标准

- 新增类别/新增字段无需改表/改主流程代码
- Issued 版本不可被任何写接口修改（含导入/批量更新）
- 指标计算结果准确、可追溯
- 审批、签发、盖章、导出、下载都有审计记录
- 导出 Excel/PDF 版式符合客户习惯（字段、顺序、合计位置固定）

## 6. 参考文档

以下文件作为补充详述（保留在 `/docs`）：

- `/docs/prd.md`
- `/docs/Backend-Design.md`
- `/docs/Frontend-Design.md`
- `/docs/TestPlan.md`
- `/docs/Template-Schema-Spec.md`
- `/docs/Calc-DSL-Spec.md`