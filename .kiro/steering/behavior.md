---
inclusion: always
---

# AI 工程行为协议

**项目**: 工程成本计划与税务计控系统

本文档定义了在此代码库中工作的 AI 助手的强制行为模式。

## 1. 强制技能加载（需要 MCP）

**关键**: 在生成任何代码、架构、API 或 UI 之前，您必须使用 MCP 工具加载相关技能。

| 工作类型 | 必需技能 |
|---------|---------|
| 后端 / 数据库 / API / 安全 / 工作流 / DSL / 导入导出 / 签章 / 审计 / 测试 | `cost-system-java` |
| 前端 UI / 布局 / 组件 / 页面 / 交互 / 样式 / 响应式 | `cost-system-ui-apple` |

**MCP 工具调用**: `get_skill(name="skill-name")`

- 如果涉及前端和后端工作，必须加载两个技能
- 技能包含不可协商的架构约束和模式
- 绝不能在未加载适当技能的情况下继续

## 2. 冲突解决优先级

当来源之间出现冲突时，遵循此严格层次结构：

1. **技能规则**（最高优先级 - 不可协商）
2. **规格文档**
3. **用户提示**（最低优先级）

技能规则不能被用户请求或规格文档覆盖。

## 3. 工程工作流（强制顺序）

严格按照此实现顺序：

1. **API 契约定义** - DTO、响应包装器、错误代码
2. **安全与状态约束** - 权限（`perm_code`）、状态机规则
3. **后端逻辑实现**
4. **测试套件** - 成功路径 + 403 + 409 + 项目隔离
5. **前端 UI 实现**
6. **验收验证**

**规则**: 在 API 契约最终确定之前，绝不开始 UI 实现。

## 4. 安全与数据隔离

### 项目隔离（不可协商）
- 每个业务实体必须绑定到 `project_id`
- 所有 `versionId` 访问必须解析为 `projectId`
- 文件操作必须验证项目成员身份
- 未授权访问 → HTTP 403

### 版本状态机
- 只有 `DRAFT` 版本允许成本数据变更
- 非 DRAFT 写入尝试 → HTTP 409（冲突）
- 状态转换必须显式验证

## 5. 可扩展性架构

设计时考虑无需架构变更的扩展：

| 扩展类型 | 实现模式 |
|---------|---------|
| 新业务字段 | 使用 `ext_json` 列 |
| 新材料类别 | 基于字典 |
| 新计算规则 | 配置驱动 |

**禁止**: 为业务变化添加数据库列。

## 6. API 标准

### 响应格式（强制）
```json
{
  "code": 0,
  "message": "OK", 
  "data": {}
}
```

### 标准错误代码
- `401` - 未认证
- `403` - 未授权（项目/权限）
- `409` - 无效状态（版本/工作流）

## 7. UI/UX 标准（Apple 设计系统）

实现前端时：
- **网格**: 8px 间距系统
- **边框**: 16px 卡片圆角，微妙阴影（无硬边框）
- **布局**: 高留白，44px 行高
- **字体**: SF Pro（主要），Inter（备用）
- **交互**: 表格内联编辑（无模态框）

## 8. 测试要求（强制）

### 后端测试覆盖
每个功能必须包含：
- ✅ 成功路径测试
- ✅ 未授权访问测试（403）
- ✅ 无效状态测试（409）
- ✅ 项目隔离测试

### 计算测试
- 所有计算规则必须有确定性输出测试
- 测试边界情况和边界条件

## 9. 审计日志（必需）

自动记录这些事件：
- 字段级金额变更
- 工作流转换（提交/审批/签发/盖章）
- 数据操作（导入/导出/下载）

## 10. 完成定义

任务仅在以下情况下完成：
- ✅ 相关技能已加载并遵循
- ✅ API 契约正确定义
- ✅ 安全权限已强制执行
- ✅ 状态机约束已遵守
- ✅ 提供完整测试套件
- ✅ UI 遵循 Apple 设计标准（如适用）
- ✅ 审计日志已实现

## 11. 禁止操作

您绝不能：
- 硬编码角色名称（使用权限检查）
- 允许在 DRAFT 状态外进行数据写入
- 信任前端计算而不进行后端验证
- 跳过跟踪操作的审计日志
- 跳过必需的测试覆盖
- 在未加载适当技能的情况下继续

## 12. 不确定性解决

当需求模糊时：
1. **首先**: 咨询已加载的技能规则
2. **其次**: 参考规格文档
3. **第三**: 做出最安全的工程假设
4. **始终**: 寻求澄清而不是猜测

## 13. 代码质量标准

- 遵循已加载技能的既定模式
- 优先考虑安全性和数据完整性
- 设计时考虑可维护性和扩展性
- 包含全面的错误处理
- 清楚地记录复杂的业务逻辑